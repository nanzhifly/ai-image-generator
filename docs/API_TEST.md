# API 测试文档

## 测试步骤

1. 环境准备
```bash
# 安装依赖
npm install dotenv node-fetch

# 设置环境变量
export DEEPSEEK_API_KEY=your_api_key
```

2. 运行测试
```bash
node scripts/api-test.js
```

## 测试用例

1. API 可用性检查
- 端点: /models
- 方法: GET
- 预期: 200 OK

2. 图片生成
- 端点: /images/generations
- 方法: POST
- 测试数据:
  ```json
  {
    "model": "deepseek-api/image-gen",
    "prompt": "test prompt",
    "n": 1,
    "size": "384x384"
  }
  ```
- 预期响应:
  ```json
  {
    "data": [{
      "url": "https://..."
    }]
  }
  ```

## 错误处理

1. 记录以下信息：
- 响应状态码
- 响应头信息
- 原始响应文本
- JSON 解析结果

2. 常见错误：
- 400: 检查请求格式
- 401: 验证 API 密钥
- 500: 服务器错误

## 测试结果记录

1. 成功案例
- 记录成功的请求格式
- 保存有效的参数组合
- 记录响应时间

2. 失败案例
- 记录错误信息
- 保存失败请求
- 分析失败原因

# API 测试问题总结

## 问题回顾与分析

### 1. 环境配置不一致
- 现象：本地和 Vercel 环境配置不同步
- 原因：
  * 缺乏环境配置同步机制
  * .env 文件管理不规范
  * 多人协作时配置混乱
- 解决方案：
  * 使用 vercel env pull 同步配置
  * 规范化环境变量管理
  * 添加配置验证机制
- 预防措施：
  * 建立环境配置检查清单
  * 自动化配置同步流程
  * 完善配置文档

### 2. API 域名配置混乱
- 现象：代码中混用多个域名
- 原因：
  * 配置分散在多处
  * 缺乏统一配置中心
  * 文档更新不及时
- 解决方案：
  * 创建统一配置文件
  * 集中管理 API 配置
  * 规范化配置引用
- 预防措施：
  * 实施配置中心化
  * 添加配置检查工具
  * 自动化配置验证

### 3. 模型参数错误
- 现象：API 调用返回 400 错误
- 原因：
  * 未仔细阅读 API 文档
  * 使用了错误的模型名称
  * 缺少必要参数
- 解决方案：
  * 更正模型名称
  * 添加必要参数
  * 完善错误处理
- 预防措施：
  * 建立 API 调用模板
  * 添加参数验证
  * 完善错误提示

## 最佳实践建议

### 1. 开发流程
- 先阅读完整 API 文档
- 建立统一配置中心
- 实现自动化测试
- 规范化错误处理

### 2. 配置管理
- 使用环境变量管理工具
- 统一配置文件结构
- 实现配置自动同步
- 添加配置验证机制

### 3. 测试规范
- 编写完整测试用例
- 实现自动化测试
- 添加性能监控
- 完善错误日志

## 改进计划

### 1. 短期优化
- 完善配置文档
- 添加配置检查工具
- 优化错误处理
- 改进测试流程

### 2. 长期规划
- 实现配置中心
- 自动化测试系统
- 监控告警机制
- 性能优化方案 